<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ciudad del Bingo - Prototipo jugable</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1221;
        --panel: #111827;
        --panel-2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #22d3ee;
        --accent-2: #f472b6;
        --border: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.08), transparent 25%),
          radial-gradient(circle at 80% 0%, rgba(244, 114, 182, 0.08), transparent 25%),
          var(--bg);
        color: var(--text);
      }
      header {
        padding: 20px 20px 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      h1 {
        margin: 0;
        font-size: clamp(26px, 3vw, 32px);
        letter-spacing: -0.02em;
      }
      .tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: rgba(34, 211, 238, 0.12);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 600;
        font-size: 13px;
        border: 1px solid rgba(34, 211, 238, 0.35);
      }
      .layout {
        display: grid;
        grid-template-columns: 320px 1fr 340px;
        gap: 16px;
        padding: 0 16px 16px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px 16px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.35);
      }
      #hud {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      .stat {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        min-width: 140px;
      }
      .stat span {
        display: block;
      }
      .stat .label {
        color: var(--muted);
        font-size: 13px;
      }
      .stat .value {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }
      #game {
        height: 600px;
        background: #0a1020;
        border-radius: 16px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }
      canvas {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        display: block;
      }
      h2 {
        margin: 0 0 10px;
        font-size: 18px;
        letter-spacing: -0.01em;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .item {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        background: var(--panel-2);
      }
      .item header {
        padding: 0;
        margin: 0 0 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .item h3 {
        margin: 0;
        font-size: 15px;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      button {
        background: linear-gradient(120deg, var(--accent), #1fa4c3);
        border: none;
        color: #0b1221;
        font-weight: 700;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        min-width: 80px;
      }
      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        color: var(--muted);
        font-size: 13px;
      }
      .pill {
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
      }
      @media (max-width: 1100px) {
        .layout {
          grid-template-columns: 1fr;
        }
        #game {
          order: -1;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="tag">Protótipo jugable</div>
      <h1>Ciudad del Bingo</h1>
    </header>
    <div class="layout">
      <aside class="panel">
        <h2>Estado</h2>
        <div id="hud"></div>
        <div class="controls" style="margin-top: 10px">
          <div class="pill">Mover: WASD / Flechas</div>
          <div class="pill">Interactuar casa: E</div>
          <div class="pill">Comprar upgrade: clic</div>
        </div>
      </aside>
      <section class="panel" id="game">
        <canvas id="canvas" width="900" height="600"></canvas>
      </section>
      <aside class="panel">
        <h2>Mejoras</h2>
        <p class="muted">Aumenta probabilidad, velocidad, BPS y valor por bingo.</p>
        <div class="list" id="upgrades"></div>
      </aside>
    </div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const hud = document.getElementById("hud");
      const upgradeList = document.getElementById("upgrades");

      const state = {
        money: 50,
        bingos: 0,
        valuePerBingo: 10,
        bps: 0,
        probAdd: 0,
        probMult: 1,
        speed: 150,
        tick: 0,
        activeVehicle: null,
        lastSaleResult: null,
      };

      const player = { x: 450, y: 300, r: 12, color: "#22d3ee", speedMultiplier: 1 };
      const keys = new Set();

      const streetGrid = {
        vertical: [180, 420, 660],
        horizontal: [140, 320, 500],
        width: 70,
      };

      const houses = [];
      const cols = [80, 300, 360, 520, 740, 820];
      const rows = [70, 230, 290, 450, 530];
      rows.forEach((y, yi) => {
        cols.forEach((x, xi) => {
          // Skip positions that would be inside a street
          const inVertical = streetGrid.vertical.some(
            (sx) => Math.abs(x - sx) < streetGrid.width / 2 + 22
          );
          const inHorizontal = streetGrid.horizontal.some(
            (sy) => Math.abs(y - sy) < streetGrid.width / 2 + 22
          );
          if (inVertical || inHorizontal) return;
          houses.push({
            x,
            y,
            baseProb: 0.22 + ((xi + yi) % 3) * 0.03 + Math.random() * 0.05,
            cooldown: 0,
            color: `hsl(${220 + ((xi + yi) % 3) * 20}, 65%, 66%)`,
          });
        });
      });

      const upgrades = [
        {
          id: "pitch",
          name: "Mejor discurso",
          desc: "+5% probabilidad",
          baseCost: 30,
          factor: 1.2,
          level: 0,
          apply: () => (state.probAdd += 0.05),
        },
        {
          id: "folletos",
          name: "Folletos premium",
          desc: "+3% prob, +0.1 BPS",
          baseCost: 50,
          factor: 1.18,
          level: 0,
          apply: () => {
            state.probAdd += 0.03;
            addBps(0.1);
          },
        },
        {
          id: "uniforme",
          name: "Uniforme pro",
          desc: "+10% velocidad",
          baseCost: 80,
          factor: 1.15,
          level: 0,
          apply: () => (state.speed *= 1.1),
        },
        {
          id: "valor",
          name: "Bingo premium",
          desc: "+15% valor por bingo",
          baseCost: 120,
          factor: 1.22,
          level: 0,
          apply: () => (state.valuePerBingo *= 1.15),
        },
        {
          id: "bike",
          name: "Bicicleta",
          desc: "+40% velocidad",
          baseCost: 160,
          factor: 1.35,
          level: 0,
          apply: () => {
            state.speed *= 1.4;
            state.activeVehicle = "Bicicleta";
          },
        },
        {
          id: "moto",
          name: "Moto",
          desc: "+100% velocidad, +5% prob",
          baseCost: 320,
          factor: 1.45,
          level: 0,
          apply: () => {
            state.speed *= 2;
            state.probAdd += 0.05;
            state.activeVehicle = "Moto";
          },
        },
        {
          id: "drone",
          name: "Dron básico",
          desc: "+0.6 BPS",
          baseCost: 90,
          factor: 1.2,
          level: 0,
          apply: () => addBps(0.6),
        },
        {
          id: "drone-adv",
          name: "Dron avanzado",
          desc: "+2 BPS",
          baseCost: 250,
          factor: 1.28,
          level: 0,
          apply: () => addBps(2),
        },
        {
          id: "megafono",
          name: "Megáfono",
          desc: "+8% prob multiplicativo",
          baseCost: 200,
          factor: 1.24,
          level: 0,
          apply: () => (state.probMult *= 1.08),
        },
        {
          id: "vallas",
          name: "Vallas en la ciudad",
          desc: "+0.4 BPS y +5% valor",
          baseCost: 280,
          factor: 1.25,
          level: 0,
          apply: () => {
            addBps(0.4);
            state.valuePerBingo *= 1.05;
          },
        },
      ];

      function addBps(value) {
        state.bps += value;
      }

      function format(num) {
        return num >= 1000 ? num.toFixed(0) : num.toFixed(1);
      }

      function renderHud() {
        hud.innerHTML = "";
        const stats = [
          { label: "Dinero", value: `$ ${state.money.toFixed(0)}` },
          { label: "Bingos totales", value: state.bingos.toFixed(0) },
          { label: "Bingos/seg", value: format(state.bps) },
          { label: "Prob. base", value: `${((0.25 + state.probAdd) * state.probMult * 100).toFixed(0)}%` },
          { label: "Velocidad", value: `${(state.speed / 150).toFixed(2)}x` },
          { label: "Vehículo", value: state.activeVehicle || "A pie" },
        ];
        stats.forEach((s) => {
          const div = document.createElement("div");
          div.className = "stat";
          div.innerHTML = `<span class="label">${s.label}</span><span class="value">${s.value}</span>`;
          hud.appendChild(div);
        });
      }

      function renderUpgrades() {
        upgradeList.innerHTML = "";
        upgrades.forEach((up) => {
          const cost = up.baseCost * Math.pow(up.factor, up.level);
          const item = document.createElement("div");
          item.className = "item";
          item.innerHTML = `
            <header>
              <h3>${up.name} <span class="muted">Lv.${up.level}</span></h3>
              <button ${state.money < cost ? "disabled" : ""}>$ ${cost.toFixed(0)}</button>
            </header>
            <div class="muted">${up.desc}</div>
          `;
          const btn = item.querySelector("button");
          btn.addEventListener("click", () => buyUpgrade(up));
          upgradeList.appendChild(item);
        });
      }

      function buyUpgrade(up) {
        const cost = up.baseCost * Math.pow(up.factor, up.level);
        if (state.money < cost) return;
        state.money -= cost;
        up.level += 1;
        up.apply();
        renderHud();
        renderUpgrades();
      }

      function attemptSale(house) {
        if (house.cooldown > 0) return;
        const prob = Math.min(0.95, (house.baseProb + state.probAdd) * state.probMult);
        const roll = Math.random();
        const success = roll < prob;
        house.cooldown = 1; // seconds
        state.lastSaleResult = success ? "Vendido" : "Rechazado";
        if (success) {
          state.bingos += 1;
          state.money += state.valuePerBingo;
        }
        renderHud();
        renderUpgrades();
      }

      function update(delta) {
        // input
        const vx = (keys.has("ArrowRight") || keys.has("d")) - (keys.has("ArrowLeft") || keys.has("a"));
        const vy = (keys.has("ArrowDown") || keys.has("s")) - (keys.has("ArrowUp") || keys.has("w"));
        const len = Math.hypot(vx, vy) || 1;
        const speed = state.speed * delta;
        player.x = Math.min(canvas.width - player.r, Math.max(player.r, player.x + (vx / len) * speed));
        player.y = Math.min(canvas.height - player.r, Math.max(player.r, player.y + (vy / len) * speed));

        houses.forEach((h) => {
          if (h.cooldown > 0) h.cooldown -= delta;
        });
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#0d1628";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // streets
        ctx.fillStyle = "#1f2937";
        streetGrid.vertical.forEach((x) => ctx.fillRect(x - streetGrid.width / 2, 0, streetGrid.width, canvas.height));
        streetGrid.horizontal.forEach((y) => ctx.fillRect(0, y - streetGrid.width / 2, canvas.width, streetGrid.width));
        ctx.setLineDash([14, 14]);
        ctx.strokeStyle = "rgba(255,255,255,0.18)";
        streetGrid.vertical.forEach((x) => {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        });
        streetGrid.horizontal.forEach((y) => {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        });
        ctx.setLineDash([]);

        // houses
        houses.forEach((h) => {
          const pulse = h.cooldown > 0 ? 0.6 : 1;
          ctx.save();
          ctx.translate(h.x, h.y);
          // shadow
          ctx.fillStyle = "rgba(0,0,0,0.25)";
          ctx.beginPath();
          ctx.roundRect(-22, -18, 44, 36, 6);
          ctx.fill();
          // base
          ctx.fillStyle = h.color;
          ctx.beginPath();
          ctx.roundRect(-20, -16, 40, 32, 6);
          ctx.fill();
          // roof
          ctx.fillStyle = "#0f172a";
          ctx.beginPath();
          ctx.moveTo(-22, -16);
          ctx.lineTo(0, -28 - pulse * 2);
          ctx.lineTo(22, -16);
          ctx.closePath();
          ctx.fill();
          // door
          ctx.fillStyle = h.cooldown > 0 ? "#4b5563" : "#fde68a";
          ctx.fillRect(-5, 4, 10, 12);
          // windows
          ctx.fillStyle = h.cooldown > 0 ? "#9ca3af" : "#fef3c7";
          ctx.fillRect(-16, -6, 10, 8);
          ctx.fillRect(6, -6, 10, 8);
          ctx.restore();

          ctx.fillStyle = "rgba(255,255,255,0.5)";
          ctx.font = "10px Inter";
          ctx.fillText(`${Math.round(Math.min(0.95, (h.baseProb + state.probAdd) * state.probMult) * 100)}%`, h.x - 16, h.y + 32);
        });

        // player
        ctx.fillStyle = player.color;
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.r, 0, Math.PI * 2);
        ctx.fill();

        // interaction prompt
        const target = houses.find((h) => Math.hypot(player.x - h.x, player.y - h.y) < 36);
        if (target) {
          ctx.fillStyle = "rgba(34,211,238,0.9)";
          ctx.fillRect(player.x - 28, player.y - 40, 56, 22);
          ctx.fillStyle = "#0b1221";
          ctx.font = "12px Inter";
          ctx.fillText("E: Vender", player.x - 24, player.y - 24);
        }

        // feedback
        if (state.lastSaleResult) {
          ctx.fillStyle = state.lastSaleResult === "Vendido" ? "#22d3ee" : "#f87171";
          ctx.font = "14px Inter";
          ctx.fillText(state.lastSaleResult, 12, canvas.height - 16);
        }
      }

      function loop(timestamp) {
        const now = timestamp / 1000;
        const delta = now - state.tick;
        state.tick = now;
        update(delta || 0);
        draw();
        requestAnimationFrame(loop);
      }

      function autoSales(delta) {
        if (state.bps <= 0) return;
        state.bingos += state.bps * delta;
        state.money += state.bps * delta * state.valuePerBingo;
        renderHud();
        renderUpgrades();
      }

      let lastAuto = performance.now();
      function autoLoop(timestamp) {
        const delta = (timestamp - lastAuto) / 1000;
        lastAuto = timestamp;
        autoSales(delta);
        requestAnimationFrame(autoLoop);
      }

      document.addEventListener("keydown", (e) => {
        keys.add(e.key);
        if (e.key === "e" || e.key === "E") {
          const target = houses.find((h) => Math.hypot(player.x - h.x, player.y - h.y) < 36);
          if (target) attemptSale(target);
        }
      });
      document.addEventListener("keyup", (e) => keys.delete(e.key));

      renderHud();
      renderUpgrades();
      state.tick = performance.now() / 1000;
      requestAnimationFrame(loop);
      requestAnimationFrame(autoLoop);
    </script>
  </body>
</html>
